/* ╔══════════════════════════════════════════════════════════════════════════╗
 * ║              Cron 表达式 → 中文可读描述                                  ║
 * ║                                                                        ║
 * ║  设计：查表优先，解析兜底                                                ║
 * ║  用数据结构驱动，消除分支堆叠                                            ║
 * ╚══════════════════════════════════════════════════════════════════════════╝ */

/* ┌──────────────────────────────────────────────────────────────────────────┐
 * │                  常见表达式 → 中文描述 速查表                             │
 * └──────────────────────────────────────────────────────────────────────────┘ */

const KNOWN: Record<string, string> = {
  '* * * * *':     '每分钟',
  '0 * * * *':     '每小时整点',
  '0 0 * * *':     '每天 凌晨 0:00',
  '0 9 * * *':     '每天 上午 9:00',
  '0 9 * * 1-5':   '每个工作日 上午 9:00',
  '0 9 * * 1':     '每周一 上午 9:00',
  '0 9 * * 2':     '每周二 上午 9:00',
  '0 9 * * 3':     '每周三 上午 9:00',
  '0 9 * * 4':     '每周四 上午 9:00',
  '0 9 * * 5':     '每周五 上午 9:00',
  '0 9 * * 6':     '每周六 上午 9:00',
  '0 9 * * 0':     '每周日 上午 9:00',
  '0 0 1 * *':     '每月 1 号 凌晨 0:00',
  '0 9 1 * *':     '每月 1 号 上午 9:00',
}

/* ┌──────────────────────────────────────────────────────────────────────────┐
 * │                  星期数字 → 中文映射                                      │
 * └──────────────────────────────────────────────────────────────────────────┘ */

const DAY_NAMES: Record<string, string> = {
  '0': '日', '1': '一', '2': '二', '3': '三',
  '4': '四', '5': '五', '6': '六', '7': '日',
}

/* ┌──────────────────────────────────────────────────────────────────────────┐
 * │                  小时 → 时段描述                                          │
 * └──────────────────────────────────────────────────────────────────────────┘ */

function hourLabel(h: number): string {
  if (h === 0) return '凌晨 0:00'
  if (h < 6)   return `凌晨 ${h}:00`
  if (h < 12)  return `上午 ${h}:00`
  if (h === 12) return '中午 12:00'
  return `下午 ${h - 12}:00`
}

/* ╔══════════════════════════════════════════════════════════════════════════╗
 * ║                  主函数：cron 表达式 → 中文                              ║
 * ╚══════════════════════════════════════════════════════════════════════════╝ */

export function cronToHuman(expr: string): string {
  const trimmed = expr.trim()

  /* 速查表命中 → 直接返回 */
  if (KNOWN[trimmed]) return KNOWN[trimmed]

  const parts = trimmed.split(/\s+/)
  if (parts.length !== 5) return `Cron: ${trimmed}`

  const [min, hour, dom, , dow] = parts

  /* 每隔 N 分钟 */
  if (min.startsWith('*/'))  return `每隔 ${min.slice(2)} 分钟`

  /* 每隔 N 小时 */
  if (hour.startsWith('*/')) return `每隔 ${hour.slice(2)} 小时`

  /* 固定小时 + 星期 */
  const h = parseInt(hour)
  const time = isNaN(h) ? hour : hourLabel(h)

  if (dow !== '*') return `每周${dayName(dow)} ${time}`
  if (dom !== '*') return `每月 ${dom} 号 ${time}`

  return `每天 ${time}`
}

/** 星期字段 → 中文（支持 1-5 范围） */
function dayName(dow: string): string {
  if (dow.includes('-')) {
    const [a, b] = dow.split('-')
    return `${DAY_NAMES[a] || a} 至 周${DAY_NAMES[b] || b}`
  }
  return DAY_NAMES[dow] || dow
}
