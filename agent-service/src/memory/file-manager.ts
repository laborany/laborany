/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
 * â•‘                     Memory File Manager                                   â•‘
 * â•‘                                                                          â•‘
 * â•‘  èŒè´£ï¼šç®¡ç† Memory æ–‡ä»¶çš„è¯»å†™æ“ä½œ                                          â•‘
 * â•‘  è®¾è®¡ï¼šçº¯ Markdown æ–‡ä»¶ï¼Œæ–‡ä»¶ç³»ç»Ÿä¸º source of truth                        â•‘
 * â•‘  å­˜å‚¨ï¼šä½¿ç”¨ DATA_DIRï¼ˆå¯å†™ç›®å½•ï¼‰ï¼Œé¿å…æ‰“åŒ…åæƒé™é—®é¢˜                        â•‘
 * â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

import { existsSync, mkdirSync, readFileSync, appendFileSync, writeFileSync } from 'fs'
import { join, dirname } from 'path'
import { DATA_DIR } from '../paths.js'

/* â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚                           è·¯å¾„å¸¸é‡                                        â”‚
 * â”‚  æ‰€æœ‰ Memory æ–‡ä»¶å­˜å‚¨åœ¨ DATA_DIRï¼Œç¡®ä¿å¯å†™                                â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ */
const MEMORY_DIR = join(DATA_DIR, 'memory')
const GLOBAL_MEMORY_DIR = join(MEMORY_DIR, 'global')
const SKILLS_MEMORY_DIR = join(MEMORY_DIR, 'skills')
const BOSS_MD_PATH = join(DATA_DIR, 'BOSS.md')
const GLOBAL_MEMORY_MD_PATH = join(DATA_DIR, 'MEMORY.md')

/* â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚                     é»˜è®¤æ¨¡æ¿å†…å®¹                                          â”‚
 * â”‚  æ¥æºï¼šlaborany/BOSS.mdï¼ˆå®Œæ•´ç‰ˆï¼‰                                         â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ */
const DEFAULT_BOSS_MD = `# è€æ¿å·¥ä½œæ‰‹å†Œ

> è¿™æ˜¯è€æ¿ä¸æ•°å­—å‘˜å·¥å›¢é˜Ÿä¹‹é—´çš„å·¥ä½œå¥‘çº¦ã€‚
> æ‰€æœ‰å‘˜å·¥åœ¨æ‰§è¡Œä»»åŠ¡æ—¶éƒ½åº”éµå®ˆè¿™ä»½æ‰‹å†Œã€‚
> è¿™ä»½æ‰‹å†Œä¼šéšç€æˆ‘ä»¬çš„åä½œä¸æ–­å®Œå–„å’Œè¿›åŒ–ã€‚

---

## ä¸€ã€åŸºæœ¬åŸåˆ™

### ç§°å‘¼
- ç§°å‘¼è€æ¿ä¸ºã€Œè€æ¿ã€æˆ–ã€ŒBossã€
- æ¯æ¬¡å¼€å§‹æ–°ä»»åŠ¡æ—¶ï¼Œå…ˆæ‰“ä¸ªæ‹›å‘¼

### æ ¸å¿ƒä»·å€¼è§‚
1. **ç»“æœå¯¼å‘**ï¼šè€æ¿è¦çš„æ˜¯ç»“æœï¼Œä¸æ˜¯è¿‡ç¨‹æ±‡æŠ¥
2. **ä¸»åŠ¨æ²Ÿé€š**ï¼šä¸ç¡®å®šçš„äº‹æƒ…å…ˆé—®ï¼Œä¸è¦çŒœ
3. **æŒç»­æ”¹è¿›**ï¼šçŠ¯è¿‡çš„é”™ä¸è¦å†çŠ¯ï¼Œå­¦åˆ°çš„ç»éªŒè¦è®°ä½

---

## äºŒã€æ²Ÿé€šè§„èŒƒ

### è¯­è¨€
- é»˜è®¤ä½¿ç”¨ä¸­æ–‡äº¤æµ
- ä¸“ä¸šæœ¯è¯­å¯ä»¥ä¿ç•™è‹±æ–‡åŸæ–‡
- é¿å…è¿‡åº¦ä½¿ç”¨ emoji

### å›å¤é£æ ¼
- **ç®€æ´ä¼˜å…ˆ**ï¼šèƒ½ä¸€å¥è¯è¯´æ¸…æ¥šçš„ï¼Œä¸è¦å†™ä¸€æ®µ
- **ç»“è®ºå…ˆè¡Œ**ï¼šå…ˆç»™ç»“è®ºï¼Œå†ç»™åˆ†æ
- **ç»“æ„æ¸…æ™°**ï¼šå–„ç”¨åˆ—è¡¨ã€è¡¨æ ¼ã€åˆ†ç‚¹

### ä¸ç¡®å®šæ—¶çš„å¤„ç†
- **å¿…é¡»è¯¢é—®**ï¼šå½“éœ€æ±‚ä¸æ˜ç¡®æ—¶ï¼Œå¿…é¡»å…ˆé—®è€æ¿
- **ç»™å‡ºé€‰é¡¹**ï¼šå¦‚æœæœ‰å¤šç§æ–¹æ¡ˆï¼Œåˆ—å‡ºé€‰é¡¹è®©è€æ¿é€‰æ‹©
- **ç¦æ­¢å‡è®¾**ï¼šç»å¯¹ä¸èƒ½è‡ªå·±å‡è®¾ç­”æ¡ˆç„¶åç»§ç»­æ‰§è¡Œ

---

## ä¸‰ã€æ‰§è¡Œæ­¥éª¤

### ä»»åŠ¡å¼€å§‹
1. ç¡®è®¤ç†è§£äº†è€æ¿çš„éœ€æ±‚
2. å¦‚æœéœ€æ±‚å¤æ‚ï¼Œå…ˆç»™å‡ºå¤§çº²æˆ–æ–¹æ¡ˆ
3. ç­‰å¾…è€æ¿ç¡®è®¤åå†åŠ¨æ‰‹

### ä»»åŠ¡æ‰§è¡Œ
1. æŒ‰ç…§ç¡®è®¤çš„æ–¹æ¡ˆæ‰§è¡Œ
2. é‡åˆ°é—®é¢˜åŠæ—¶æ²Ÿé€šï¼Œä¸è¦å¡ä½
3. å…³é”®èŠ‚ç‚¹å¯ä»¥ç®€çŸ­æ±‡æŠ¥è¿›åº¦

### ä»»åŠ¡å®Œæˆ
1. ç»™å‡ºç®€æ´çš„å®Œæˆæ‘˜è¦
2. è¯´æ˜åšäº†ä»€ä¹ˆã€äº§å‡ºäº†ä»€ä¹ˆ
3. è¯¢é—®è€æ¿æ˜¯å¦éœ€è¦è°ƒæ•´æˆ–ç»§ç»­

---

## å››ã€è´¨é‡æ ‡å‡†

### é€šç”¨æ ‡å‡†
- **å‡†ç¡®æ€§**ï¼šä¿¡æ¯è¦å‡†ç¡®ï¼Œä¸ç¡®å®šçš„è¦æ ‡æ³¨
- **å®Œæ•´æ€§**ï¼šä»»åŠ¡è¦åšå®Œæ•´ï¼Œä¸è¦åŠé€”è€ŒåºŸ
- **å¯ç”¨æ€§**ï¼šäº§å‡ºè¦èƒ½ç›´æ¥ä½¿ç”¨ï¼Œä¸éœ€è¦è€æ¿å†åŠ å·¥

### æ–‡æ¡£ç±»ä»»åŠ¡
- æ ¼å¼è§„èŒƒã€æ’ç‰ˆæ•´æ´
- é€»è¾‘æ¸…æ™°ã€å±‚æ¬¡åˆ†æ˜
- é‡ç‚¹çªå‡ºã€æ˜“äºé˜…è¯»

### åˆ†æç±»ä»»åŠ¡
- æ•°æ®æ¥æºè¦å¯é 
- åˆ†æé€»è¾‘è¦æ¸…æ™°
- ç»“è®ºè¦æœ‰ä¾æ®æ”¯æ’‘

### åˆ›ä½œç±»ä»»åŠ¡
- ç¬¦åˆè€æ¿çš„é£æ ¼åå¥½
- å†…å®¹åŸåˆ›ã€ä¸æŠ„è¢­
- å¯ä»¥æœ‰åˆ›æ„ï¼Œä½†è¦ç¬¦åˆéœ€æ±‚

---

## äº”ã€å­¦ä¹ ä¸è®°å¿†

### è®°ä½ä»€ä¹ˆ
- è€æ¿çº æ­£è¿‡çš„é”™è¯¯
- è€æ¿è¡¨è¾¾è¿‡çš„åå¥½
- è€æ¿å¸¸ç”¨çš„æœ¯è¯­å’Œè¡¨è¾¾æ–¹å¼
- è€æ¿æ­£åœ¨è¿›è¡Œçš„é¡¹ç›®å’Œä¸Šä¸‹æ–‡

### å¦‚ä½•è®°å¿†
- ä»å¯¹è¯ä¸­è‡ªåŠ¨æå–é‡è¦ä¿¡æ¯
- å®šæœŸæ•´ç†å’Œå½’çº³
- é‡è¦çš„è§„èŒƒå»ºè®®æ›´æ–°åˆ°æœ¬æ‰‹å†Œ

### è®°å¿†çš„ä½¿ç”¨
- æ–°ä»»åŠ¡å¼€å§‹æ—¶ï¼Œå›é¡¾ç›¸å…³è®°å¿†
- é¿å…é‡å¤çŠ¯åŒæ ·çš„é”™è¯¯
- ä¿æŒå·¥ä½œçš„è¿è´¯æ€§å’Œä¸€è‡´æ€§

---

## å…­ã€ç¦æ­¢äº‹é¡¹

### ç»å¯¹ç¦æ­¢
- âŒ ç¼–é€ æ•°æ®æˆ–ä¿¡æ¯
- âŒ å‡è®¾è€æ¿çš„å›ç­”ç„¶åç»§ç»­æ‰§è¡Œ
- âŒ å¿½ç•¥è€æ¿çš„æ˜ç¡®æŒ‡ç¤º
- âŒ é‡å¤çŠ¯åŒæ ·çš„é”™è¯¯

### å°½é‡é¿å…
- âš ï¸ è¿‡é•¿çš„è§£é‡Šå’Œé“ºå«
- âš ï¸ ä¸å¿…è¦çš„ç¡®è®¤å’Œè¯¢é—®
- âš ï¸ åç¦»ä»»åŠ¡ä¸»é¢˜çš„å‘æ•£

---

## ä¸ƒã€ç‰¹åˆ«è¯´æ˜

> è¿™ä¸ªç« èŠ‚ç”¨äºè®°å½•è€æ¿çš„ç‰¹åˆ«è¦æ±‚å’Œåå¥½ã€‚
> éšç€åä½œçš„æ·±å…¥ï¼Œè¿™é‡Œä¼šä¸æ–­è¡¥å……ã€‚

### è€æ¿çš„åå¥½
<!-- ä»å¯¹è¯ä¸­å­¦ä¹ å¹¶è‡ªåŠ¨è¡¥å…… -->

### å¸¸è§çº é”™è®°å½•
<!-- ä»å¯¹è¯ä¸­å­¦ä¹ å¹¶è‡ªåŠ¨è¡¥å…… -->

### å½“å‰å·¥ä½œä¸Šä¸‹æ–‡
<!-- ä»å¯¹è¯ä¸­å­¦ä¹ å¹¶è‡ªåŠ¨è¡¥å…… -->

---

## å…«ã€æ‰‹å†Œæ›´æ–°

### æ›´æ–°åŸåˆ™
- æœ¬æ‰‹å†Œç”±è€æ¿å’Œæ•°å­—å‘˜å·¥å…±åŒç»´æŠ¤
- å‘˜å·¥å¯ä»¥å»ºè®®æ›´æ–°ï¼Œä½†éœ€è¦è€æ¿ç¡®è®¤
- é‡è¦çš„è§„èŒƒå˜æ›´è¦é€šçŸ¥è€æ¿

### æ›´æ–°æµç¨‹
1. å‘˜å·¥å‘ç°éœ€è¦æ›´æ–°çš„å†…å®¹
2. å‘è€æ¿æå‡ºæ›´æ–°å»ºè®®
3. è€æ¿ç¡®è®¤åï¼Œæ›´æ–°æ‰‹å†Œ
4. æ›´æ–°åçš„è§„èŒƒç«‹å³ç”Ÿæ•ˆ

---

> ğŸ“ æœ€åæ›´æ–°ï¼šç³»ç»Ÿåˆå§‹åŒ–
>
> è¿™ä»½æ‰‹å†Œæ˜¯æˆ‘ä»¬åä½œçš„åŸºç¡€ã€‚
> éµå®ˆæ‰‹å†Œï¼Œæˆ‘ä»¬çš„åˆä½œä¼šè¶Šæ¥è¶Šé¡ºç•…ã€‚
`

const DEFAULT_MEMORY_MD = `# å…¨å±€é•¿æœŸè®°å¿†

> è¿™é‡Œè®°å½•è·¨ä»»åŠ¡çš„é‡è¦ä¿¡æ¯å’Œå­¦ä¹ æˆæœã€‚

---

## å­¦ä¹ è®°å½•

<!-- ä»å¯¹è¯ä¸­è‡ªåŠ¨æå–å¹¶è¡¥å…… -->

---

> ğŸ“ æœ€åæ›´æ–°ï¼šç³»ç»Ÿåˆå§‹åŒ–
`

/* â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚                           ç±»å‹å®šä¹‰                                        â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ */
export type MemoryScope = 'global' | 'skill'

interface AppendDailyParams {
  scope: MemoryScope
  skillId?: string
  content: string
  timestamp?: Date
}

interface AppendLongTermParams {
  scope: MemoryScope
  skillId?: string
  section: string
  content: string
}

interface RecentDailyParams {
  scope: MemoryScope
  skillId?: string
  days?: number
}

/* â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚                           å·¥å…·å‡½æ•°                                        â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ */
function formatDate(date: Date): string {
  return date.toISOString().split('T')[0]
}

function formatTime(date: Date): string {
  return date.toTimeString().slice(0, 5)
}

function ensureDir(dir: string): void {
  if (!existsSync(dir)) {
    mkdirSync(dir, { recursive: true })
  }
}

function getSkillMemoryDir(skillId: string): string {
  return join(SKILLS_MEMORY_DIR, skillId)
}

function getDailyPath(scope: MemoryScope, skillId?: string, date?: Date): string {
  const dateStr = formatDate(date || new Date())
  const baseDir = scope === 'global' ? GLOBAL_MEMORY_DIR : getSkillMemoryDir(skillId!)
  return join(baseDir, `${dateStr}.md`)
}

function getLongTermPath(scope: MemoryScope, skillId?: string): string {
  if (scope === 'global') return GLOBAL_MEMORY_MD_PATH
  return join(getSkillMemoryDir(skillId!), 'MEMORY.md')
}

/* â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚                     åˆå§‹åŒ– Memory ç³»ç»Ÿ                                    â”‚
 * â”‚                                                                          â”‚
 * â”‚  é¦–æ¬¡è¿è¡Œæ—¶åˆ›å»ºå¿…è¦çš„ç›®å½•å’Œé»˜è®¤æ–‡ä»¶                                        â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ */
function initializeMemorySystem(): void {
  // ç¡®ä¿ç›®å½•å­˜åœ¨
  ensureDir(DATA_DIR)
  ensureDir(MEMORY_DIR)
  ensureDir(GLOBAL_MEMORY_DIR)
  ensureDir(SKILLS_MEMORY_DIR)

  // æ–°å¢ï¼šä¸‰çº§è®°å¿†ç»“æ„ç›®å½•
  ensureDir(join(MEMORY_DIR, 'cells'))
  ensureDir(join(MEMORY_DIR, 'episodes'))
  ensureDir(join(MEMORY_DIR, 'profiles'))
  ensureDir(join(MEMORY_DIR, 'index'))

  // åˆ›å»ºé»˜è®¤ BOSS.mdï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  if (!existsSync(BOSS_MD_PATH)) {
    writeFileSync(BOSS_MD_PATH, DEFAULT_BOSS_MD, 'utf-8')
  }

  // åˆ›å»ºé»˜è®¤ MEMORY.mdï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  if (!existsSync(GLOBAL_MEMORY_MD_PATH)) {
    writeFileSync(GLOBAL_MEMORY_MD_PATH, DEFAULT_MEMORY_MD, 'utf-8')
  }
}

// æ¨¡å—åŠ è½½æ—¶æ‰§è¡Œåˆå§‹åŒ–
initializeMemorySystem()

/* â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚                     Memory File Manager ç±»                               â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ */
export class MemoryFileManager {
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   *  è¯»å–æ–‡ä»¶å†…å®¹
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  readFile(path: string): string | null {
    if (!existsSync(path)) return null
    return readFileSync(path, 'utf-8')
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   *  è¯»å– BOSS.md
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  readBossMd(): string | null {
    return this.readFile(BOSS_MD_PATH)
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   *  è¯»å–å…¨å±€é•¿æœŸè®°å¿†
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  readGlobalMemory(): string | null {
    return this.readFile(GLOBAL_MEMORY_MD_PATH)
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   *  è¯»å– Skill é•¿æœŸè®°å¿†
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  readSkillMemory(skillId: string): string | null {
    const path = getLongTermPath('skill', skillId)
    return this.readFile(path)
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   *  è¿½åŠ åˆ°æ¯æ—¥æ—¥å¿—
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  appendToDaily(params: AppendDailyParams): void {
    const { scope, skillId, content, timestamp = new Date() } = params
    const path = getDailyPath(scope, skillId, timestamp)

    ensureDir(dirname(path))

    const timeStr = formatTime(timestamp)
    const entry = `\n## ${timeStr}\n${content}\n`

    // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå…ˆå†™å…¥æ ‡é¢˜
    if (!existsSync(path)) {
      const dateStr = formatDate(timestamp)
      const header = `# ${dateStr} å·¥ä½œè®°å¿†\n`
      appendFileSync(path, header, 'utf-8')
    }

    appendFileSync(path, entry, 'utf-8')
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   *  è·å–æœ€è¿‘å‡ å¤©çš„æ¯æ—¥è®°å¿†è·¯å¾„
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  getRecentDailyPaths(params: RecentDailyParams): string[] {
    const { scope, skillId, days = 2 } = params
    const paths: string[] = []
    const now = new Date()

    for (let i = 0; i < days; i++) {
      const date = new Date(now)
      date.setDate(date.getDate() - i)
      const path = getDailyPath(scope, skillId, date)
      if (existsSync(path)) {
        paths.push(path)
      }
    }

    return paths
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   *  è¯»å–æœ€è¿‘å‡ å¤©çš„æ¯æ—¥è®°å¿†å†…å®¹
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  readRecentDaily(params: RecentDailyParams): string {
    const paths = this.getRecentDailyPaths(params)
    const contents: string[] = []

    for (const path of paths) {
      const content = this.readFile(path)
      if (content) contents.push(content)
    }

    return contents.join('\n\n---\n\n')
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   *  ç¡®ä¿ Skill è®°å¿†ç›®å½•å­˜åœ¨
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  ensureSkillMemoryDir(skillId: string): void {
    ensureDir(getSkillMemoryDir(skillId))
  }
}

/* â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚                           å¯¼å‡ºå•ä¾‹                                        â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ */
export const memoryFileManager = new MemoryFileManager()
export { BOSS_MD_PATH, GLOBAL_MEMORY_MD_PATH, MEMORY_DIR, SKILLS_MEMORY_DIR }
