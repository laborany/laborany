/* ╔══════════════════════════════════════════════════════════════════════════╗
 * ║                         沙盒类型定义                                      ║
 * ║                                                                          ║
 * ║  职责：定义脚本执行的接口和类型                                            ║
 * ║  设计：简洁、直白，只包含必要的抽象                                        ║
 * ╚══════════════════════════════════════════════════════════════════════════╝ */

/* ┌──────────────────────────────────────────────────────────────────────────┐
 * │                           脚本执行选项                                    │
 * └──────────────────────────────────────────────────────────────────────────┘ */
export interface ScriptExecOptions {
  /** 脚本文件路径 */
  scriptPath: string
  /** 工作目录 */
  workDir: string
  /** 命令行参数 */
  args?: string[]
  /** 环境变量 */
  env?: Record<string, string>
  /** 超时时间（毫秒） */
  timeout?: number
  /** 需要安装的依赖包 */
  packages?: string[]
}

/* ┌──────────────────────────────────────────────────────────────────────────┐
 * │                           脚本执行结果                                    │
 * └──────────────────────────────────────────────────────────────────────────┘ */
export interface ScriptExecResult {
  /** 是否成功 */
  success: boolean
  /** 标准输出 */
  stdout: string
  /** 标准错误 */
  stderr: string
  /** 退出码 */
  exitCode: number
  /** 执行耗时（毫秒） */
  duration: number
  /** 执行提供者信息 */
  provider?: {
    type: string
    name: string
    isolation: 'vm' | 'container' | 'process' | 'none'
  }
}

/* ┌──────────────────────────────────────────────────────────────────────────┐
 * │                           沙盒提供者接口                                  │
 * └──────────────────────────────────────────────────────────────────────────┘ */
export interface ISandboxProvider {
  /** 提供者类型标识 */
  readonly type: string
  /** 提供者名称 */
  readonly name: string

  /** 检查提供者是否可用 */
  isAvailable(): Promise<boolean>

  /** 初始化提供者 */
  init(): Promise<void>

  /** 执行脚本 */
  runScript(options: ScriptExecOptions): Promise<ScriptExecResult>

  /** 停止并清理 */
  stop(): Promise<void>
}

/* ┌──────────────────────────────────────────────────────────────────────────┐
 * │                           提供者工厂类型                                  │
 * └──────────────────────────────────────────────────────────────────────────┘ */
export type SandboxProviderFactory = () => ISandboxProvider

/* ┌──────────────────────────────────────────────────────────────────────────┐
 * │                           默认配置                                        │
 * └──────────────────────────────────────────────────────────────────────────┘ */
export const DEFAULT_TIMEOUT = 120000  // 2 分钟
export const DEFAULT_PYTHON_VERSION = '3.11'
