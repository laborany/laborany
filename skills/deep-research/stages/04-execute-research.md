# 阶段4：执行研究

## 目标

基于用户确认的研究提示词，执行多源网络搜索，收集信息，合成完整的 Markdown 研究报告并保存。报告中所有关键信息必须附带可点击的引用链接。

## 前置条件

- 用户已确认研究提示词
- 已有完整的研究提示词（含研究框架、子问题、信息来源指引、输出格式）

---

## 步骤1：确认保存路径

向用户询问报告保存位置：

```
请指定研究报告的保存路径：

建议路径：./docs/{主题关键词}-{YYYY-MM-DD}.md

请输入路径，或直接回车使用建议路径：
```

如果用户未指定，使用建议路径。确保目录存在，必要时创建。

---

## 步骤2：制定多源搜索计划

### 搜索源覆盖要求

每次研究的搜索平台来自阶段1发现的【领域权威信息源】，不使用硬编码的平台列表。

#### 领域专业平台（来自阶段1）

直接使用阶段1中通过搜索发现的领域权威中英文平台。搜索时使用 `site:` 前缀限定域名：

```
site:{domain} {关键词}
```

例如，如果阶段1发现医疗领域的权威源包括丁香园（dxy.cn）和 PubMed（pubmed.ncbi.nlm.nih.gov），则：
- `site:dxy.cn {关键词}`
- `site:pubmed.ncbi.nlm.nih.gov {keywords}`

#### 通用来源（所有研究必搜）

| 类型 | 说明 |
|------|------|
| 官方网站/文档 | 产品官网、官方博客、白皮书 |
| 权威媒体 | 阶段1中识别的该领域权威媒体 |
| 学术/报告 | 阶段1中识别的该领域学术平台，以及通用学术源（Google Scholar、arXiv 等） |

### 构建查询列表

从研究提示词中提取查询，按以下结构组织：

```
【搜索计划】

主题：{研究主题}
领域：{阶段1识别的领域}
预计搜索次数：{N} 次（广度搜索 + 平台定向搜索）

第一组：广度搜索（通用查询）
1. {主查询} — 全貌概览
2. {子问题1查询} — 对应子问题1
3. {子问题2查询} — 对应子问题2
...

第二组：平台定向搜索（领域权威平台）
{N+1}. site:{领域中文平台1域名} {关键词} — {平台名}讨论
{N+2}. site:{领域中文平台2域名} {关键词} — {平台名}内容
{N+3}. site:{领域英文平台1域名} {keywords} — {平台名}讨论
{N+4}. site:{领域英文平台2域名} {keywords} — {平台名}内容
...

第三组：官方/权威来源
{M+1}. {产品/公司名} official blog — 官方信息
{M+2}. {关键词} site:{权威媒体域名} — 权威报道
...

搜索参数：
- content_size: high
- location: {cn/us}（根据查询语言切换）
- search_recency_filter: {值}

开始执行...
```

### 搜索参数决策表

| 研究类型 | location | search_recency_filter | content_size |
|---------|----------|----------------------|--------------|
| 事实收集型 | 按查询语言 | 按时间要求 | high |
| 趋势分析型 | 按查询语言 | oneYear | high |
| 观点整理型 | 按查询语言 | oneYear | high |
| 深度研究型 | 按查询语言 | noLimit | high |
| 探索了解型 | 按查询语言 | oneYear | high |

> 中文查询用 `cn`，英文查询用 `us`。同一次研究中可以混合使用。

---

## 步骤3：执行搜索

### 第一轮：广度搜索 + 平台定向搜索

使用 `mcp__web-search-prime__webSearchPrime` 执行所有查询。

- **尽可能并行执行**多个搜索（在同一消息中发起多个工具调用）
- 中文查询和英文查询分别设置 `location` 参数
- 平台定向搜索使用 `site:` 前缀限定域名
- 每个查询收集：标题、URL、摘要、网站名称

### 第二轮：深度阅读

从第一轮结果中筛选 5-8 篇最相关的文章，使用 `mcp__web-reader__webReader` 获取全文。

筛选标准（按优先级）：
1. 官方来源（官网、官方博客、白皮书）
2. 社区深度讨论（知乎长回答、Reddit 高赞帖、HN 讨论）
3. 权威媒体深度报道
4. 内容相关度高且信息密度大
5. 时效性强

参数：
- `return_format`: "markdown"
- `with_links_summary`: true

### 第三轮：补充搜索（按需）

如果前两轮后某个子问题信息明显不足：
- 调整关键词重新搜索
- 尝试不同平台的定向搜索
- 最多补充 3 次
- 如果仍不足，在报告中标注信息缺口

### 进度反馈

每完成一轮搜索，向用户简要汇报：

```
第一轮广度搜索完成：执行 {N} 次查询，收集 {M} 条结果
  - 中文平台：{X} 条（{平台A} {a}、{平台B} {b}...）
  - 英文平台：{Y} 条（{平台C} {d}、{平台D} {e}...）
  - 通用来源：{Z} 条

第二轮深度阅读完成：精读 {K} 篇文章
```

---

## 步骤4：信息整理与验证

### 按子问题归类

将收集到的信息按研究框架的维度和子问题归类：

```
子问题1：{问题描述}
├── 事实/数据：[来源A](URL) ... / [来源B](URL) ...
├── 观点/分析：[来源C](URL) ...
└── 来源 URL 列表

子问题2：{问题描述}
├── ...
```

### 交叉验证规则

- 关键事实：至少 2 个独立来源确认 → 标记为"已验证"
- 单一来源的重要信息 → 标记为"待验证"
- 来源间存在矛盾 → 在报告中呈现分歧，注明各方说法
- 无法找到信息的子问题 → 在报告中明确标注

---

## 步骤5：合成研究报告

### 引用链接规则（核心要求）

报告中的引用链接必须遵循以下规则：

#### 行内引用格式

在正文中，每个关键论断、数据、观点后面直接附带来源链接：

```markdown
根据官方数据，该产品月活用户已突破500万（[来源](https://example.com/article)）。

知乎用户 @某某 在使用体验中提到："实际使用下来感觉xxx"（[知乎讨论](https://zhihu.com/question/xxx)）。

Reddit 社区中多位用户反馈了类似问题（[Reddit帖子](https://reddit.com/r/xxx/comments/xxx)）。
```

#### 脚注引用格式（用于密集引用段落）

```markdown
该技术在2025年取得重大突破[^1]，多家公司随后跟进[^2][^3]。

[^1]: [突破性进展详情](https://example.com/breakthrough) — TechCrunch, 2025-06
[^2]: [公司A的跟进](https://example.com/company-a) — 官方博客, 2025-08
[^3]: [公司B的响应](https://example.com/company-b) — The Verge, 2025-09
```

#### 引用密度要求

- 每个主要段落至少 1 个引用链接
- 数据/统计必须有引用
- 直接引用（引号内容）必须有引用
- 观点归属必须有引用
- 目标：读者可以点击任何引用链接验证原文

### 报告结构

使用阶段2-3中用户选定的输出格式模板（参见 `templates/output-format.md`）。

报告必须包含以下部分：

#### 头部元数据（YAML frontmatter）

```yaml
---
title: "{研究主题}"
date: "{YYYY-MM-DD}"
framework: "{使用的研究框架名称}"
depth: "{简洁/标准/完整}"
sources_count: {信息源数量}
platforms_searched: ["{平台1}", "{平台2}", ...]
generated_by: "Deep Research Skill"
---
```

#### 正文

严格按照选定的输出格式模板组织内容，用搜索收集到的真实信息填充每个章节。

写作要求：
- 用事实和数据说话，避免空泛描述
- **关键论断后必须标注来源链接**（使用行内或脚注格式）
- 直接引用用引用块格式，并附来源链接
- 数据用表格呈现，表格中的数据标注来源
- 客观中立，主观判断明确标注
- 社区观点注明平台和用户（如"知乎用户"、"Reddit r/xxx"）

#### 信息来源汇总（必须）

按平台分类列出所有引用的来源：

```markdown
## 信息来源

### 官方来源
1. [{文章标题}]({URL}) — {网站名称}，{日期}

### 中文平台
2. [{文章标题}]({URL}) — {平台名称}，{日期}
3. [{文章标题}]({URL}) — {平台名称}，{日期}

### 英文平台
4. [{文章标题}]({URL}) — {平台名称}，{日期}
5. [{文章标题}]({URL}) — {平台名称}，{日期}

### 学术与报告
6. [{文章标题}]({URL}) — {来源}，{日期}
```

#### 研究局限性（必须）

```markdown
## 研究局限性

- 本报告基于网络公开信息，可能存在信息获取限制
- 搜索结果受搜索引擎索引范围影响
- 部分平台内容（如需登录的知乎回答、Twitter帖子）可能无法完整获取
- 社交媒体观点不代表统计学意义上的多数意见
- 报告生成时间：{时间}，信息时效性以此为准
```

### 质量自检

生成报告前确认：
- [ ] 所有子问题是否都有回答（或标注了信息缺口）
- [ ] 关键数据是否都标注了来源链接
- [ ] 引用链接是否可点击（完整URL格式）
- [ ] 中英文平台来源是否都有覆盖
- [ ] 内容是否自相矛盾
- [ ] 格式是否符合选定模板
- [ ] 来源汇总列表是否完整

---

## 步骤6：保存并确认

使用 Write 工具将报告保存到用户指定路径。

保存后展示摘要：

```
研究报告已生成

报告路径：{完整路径}
信息来源：{N} 个
  - 中文平台：{X} 个
  - 英文平台：{Y} 个
  - 官方/权威：{Z} 个
搜索次数：{N} 次
深度阅读：{N} 篇

报告中所有关键信息均附有引用链接，你可以点击查看原文。
```

---

## 步骤7：后续操作

询问用户是否需要：
- 补充某个子问题的研究深度
- 针对某个平台（如Reddit、知乎）做更深入的挖掘
- 调整报告格式或结构
- 针对某个发现做更深入的研究
- 生成报告的摘要版本

---

## 错误处理

| 场景 | 处理方式 |
|------|---------|
| 搜索返回空结果 | 简化关键词重试一次，仍失败则跳过并记录 |
| `site:` 定向搜索无结果 | 去掉 `site:` 限制，用平台名+关键词重试 |
| webReader 读取失败 | 跳过该文章，选择下一个候选 URL |
| 连续 3 次搜索失败 | 通知用户，建议调整研究方向 |
| 某子问题信息不足 | 在报告中明确标注，建议用户后续补充 |
| 某平台完全无法访问 | 在研究局限性中说明，用其他平台补充 |
