# XLSX 多轮修改工作流指南

> 本文档详细说明如何在多轮对话中追踪文档状态、生成修改摘要、处理用户反馈。

---

## 核心理念

**增量修改优于全量重写**

每次修改只触及需要变更的部分，保留原文档的：
- 格式和样式
- 公式和计算
- 图表和可视化
- 数据验证规则

---

## 工作流程

### 第一轮：初始分析

```
1. 用户提供文档
   ↓
2. 解包并分析文档结构
   python ooxml/scripts/unpack.py doc.xlsx unpacked/
   ↓
3. 向用户确认需求
   - 任务类型？（编辑/分析/可视化）
   - 具体要求？
   - 样式偏好？
```

### 后续轮次：增量修改

```
1. 接收用户反馈
   ↓
2. 定位需要修改的部分
   - 使用 Workbook 类定位单元格
   - 记录修改位置
   ↓
3. 执行修改
   ↓
4. 生成修改摘要
   ↓
5. 询问后续需求
```

---

## 文档状态追踪

### 状态信息

每轮对话需要追踪：

| 信息 | 说明 |
|------|------|
| 文档路径 | 当前操作的文档位置 |
| 解压目录 | unpacked 目录路径 |
| 工作表列表 | 所有工作表名称 |
| 修改历史 | 本次会话的所有修改 |
| 待确认项 | 需要用户确认的问题 |

### 状态模板

```
## 当前文档状态

- 文档: [文件名]
- 解压目录: [路径]
- 工作表: [Sheet1, Sheet2, ...]
- 已完成修改: [N] 处
- 待处理: [描述]
```

---

## 修改摘要生成

### 格式规范

```markdown
## 修改摘要

本次修改共涉及 N 处变更：

### 数据修改
1. **单元格 [引用]**:
   - 原值: "[原内容]"
   - 新值: "[新内容]"

### 公式添加
1. **单元格 [引用]**: 新增公式 "[公式]"

### 格式调整
1. **范围 [引用]**: [调整说明]

### 新增内容
1. **位置 [引用]**: 新增 [内容描述]
```

### 示例

```markdown
## 修改摘要

本次修改共涉及 5 处变更：

### 数据修改
1. **单元格 C5**:
   - 原值: "100"
   - 新值: "200"

2. **单元格 D5**:
   - 原值: "50"
   - 新值: "75"

### 公式添加
1. **单元格 E5**: 新增公式 "=C5*D5"

### 格式调整
1. **范围 A1:E1**: 应用表头样式（加粗 + 蓝色背景）
2. **范围 E2:E10**: 应用货币格式
```

---

## 用户反馈处理

### 反馈类型与响应

| 反馈类型 | 响应方式 |
|---------|---------|
| 确认完成 | 打包文档，提供下载 |
| 继续修改 | 进入下一轮修改 |
| 撤销修改 | 回退到上一版本 |
| 调整修改 | 修正刚才的变更 |

### 响应模板

**确认完成时：**
```
文档已完成所有修改。

修改总结：
- 数据修改: N 处
- 公式添加: N 处
- 格式调整: N 处

文档已保存为: [文件名]
```

**继续修改时：**
```
好的，请告诉我还需要修改什么。

当前文档状态：
- 已完成 N 处修改
- 最后修改: [描述]
```

---

## 最佳实践

### 1. 精确定位

使用多种方式定位修改位置：
- 单元格引用（A1, B2:D10）
- 工作表名称 + 单元格
- 行号/列号
- 唯一文本内容

**避免**：使用模糊描述（"那个表格"、"第一列"）

### 2. 最小化修改

```python
# 好的做法：只修改变化的单元格
wb.set_cell("C5", 200)

# 避免：重写整个区域
wb.set_range("A1", [[...整个表格...]])
```

### 3. 批量处理

相关修改分组处理：
- 同一列的多处修改 → 一次处理
- 同类型修改（如格式更新）→ 批量处理
- 每批 5-20 处修改

### 4. 验证修改

每次修改后验证：
```bash
# 验证文档结构
python ooxml/scripts/validate.py unpacked/

# 打包并用 Excel 打开验证
python ooxml/scripts/pack.py unpacked/ output.xlsx
```

---

## 常见场景

### 场景1：批量数据更新

```
用户: 把 C 列所有价格提高 10%

响应:
1. 读取 C 列所有数值
2. 计算新值（原值 * 1.1）
3. 批量更新
4. 生成摘要：共 N 处价格已更新
```

### 场景2：添加汇总公式

```
用户: 在最后一行添加合计

响应:
1. 确定数据范围
2. 在最后一行添加 SUM 公式
3. 应用合计行样式
4. 生成摘要：已添加汇总行
```

### 场景3：格式统一

```
用户: 把所有金额列改成货币格式

响应:
1. 识别金额列
2. 应用货币数字格式
3. 生成摘要：N 列已应用货币格式
```

### 场景4：多轮迭代

```
第1轮: 用户提供文档，要求修改数据
第2轮: 用户要求添加公式
第3轮: 用户要求调整格式
第4轮: 用户确认完成

每轮都：
- 执行修改
- 生成摘要
- 询问后续
```

---

## 错误处理

### 常见错误

| 错误 | 原因 | 解决方案 |
|------|------|---------|
| XML 解析失败 | 文档损坏 | 尝试修复或重新获取 |
| 单元格不存在 | 引用超出范围 | 检查工作表范围 |
| 公式错误 | 语法或引用错误 | 验证公式语法 |
| 样式应用失败 | 样式 ID 无效 | 检查 styles.xml |

### 恢复策略

1. 保留原始文档备份
2. 每批修改后验证
3. 出错时回退到上一个正确状态

---

## 工具命令速查

```bash
# 解包文档
python ooxml/scripts/unpack.py doc.xlsx unpacked/

# 打包文档
python ooxml/scripts/pack.py unpacked/ output.xlsx

# 验证文档
python ooxml/scripts/validate.py unpacked/

# 公式重算
python scripts/recalc.py input.xlsx output.xlsx
```

---

## Python API 速查

```python
from skills.xlsx.scripts import Workbook

# 初始化
wb = Workbook("unpacked/")

# 读取单元格
value = wb.get_cell("A1", sheet_index=0)

# 写入单元格
wb.set_cell("A1", "新值", sheet_index=0)

# 批量写入
wb.set_range("A1", [["a", "b"], ["c", "d"]])

# 应用主题
wb.apply_theme("financial")

# 保存
wb.save("output/")
wb.pack("output.xlsx")
```
