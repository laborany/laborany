# PPTX 多轮修改工作流指南

> 本文档详细说明如何在多轮对话中追踪演示文稿状态、生成修改摘要、处理用户反馈。

---

## 核心理念

**增量修改优于全量重写**

每次修改只触及需要变更的部分，保留原演示文稿的：
- 格式和样式
- 主题设置
- 动画效果
- 媒体资源

---

## 工作流程

### 第一轮：初始分析

```
1. 用户提供演示文稿或需求
   ↓
2. 读取并分析演示结构
   - python ooxml/scripts/unpack.py pres.pptx unpacked/
   - 分析 ppt/presentation.xml 获取幻灯片列表
   - 分析 ppt/slides/slide*.xml 获取内容
   ↓
3. 向用户确认需求
   - 任务类型？
   - 具体要求？
   - 风格偏好？
```

### 后续轮次：增量修改

```
1. 接收用户反馈
   ↓
2. 定位需要修改的部分
   - 使用幻灯片编号定位
   - 使用 grep 在 slide*.xml 中搜索文本
   - 记录修改位置
   ↓
3. 执行修改
   - 新建演示：修改 pptxgenjs 代码重新生成
   - 现有演示：使用 Presentation 类编辑 XML
   ↓
4. 生成修改摘要
   ↓
5. 询问后续需求
```

---

## 演示文稿状态追踪

### 状态信息

每轮对话需要追踪：

| 信息 | 说明 |
|------|------|
| 文档路径 | 当前操���的演示文稿位置 |
| 解压目录 | unpacked 目录路径 |
| 幻灯片数量 | 当前演示的页数 |
| 修改历史 | 本次会话的所有修改 |
| 待确认项 | 需要用户确认的问题 |

### 状态模板

```
## 当前演示状态

- 文档: [文件名]
- 解压目录: [路径]
- 幻灯片数量: [N] 页
- 已完成修改: [N] 处
- 待处理: [描述]
```

---

## 修改摘要生成

### 格式规范

```markdown
## 修改摘要

本次修改共涉及 N 处变更：

### 内容修改
1. **幻灯片 [N] - [标题]**:
   - 原文: "[原内容]"
   - 改为: "[新内容]"

### 格式调整
1. **幻灯片 [N]**: [调整说明]

### 新增幻灯片
1. **位置 [N]**: 新增 [内容描述]

### 删除幻灯片
1. **幻灯片 [N]**: 删除 [内容描述]
```

### 示例

```markdown
## 修改摘要

本次修改共涉及 3 处变更：

### 内容修改
1. **幻灯片 1 - 封面**:
   - 原文: "2024年度报告"
   - 改为: "2025年度报告"

2. **幻灯片 5 - 数据分析**:
   - 原文: "增长率 15%"
   - 改为: "增长率 23%"

### 格式调整
1. **幻灯片 3**: 标题字号从 32pt 调整为 36pt
```

---

## 用户反馈处理

### 反馈类型与响应

| 反馈类型 | 响应方式 |
|---------|---------|
| 确认完成 | 打包文档，提供下载 |
| 继续修改 | 进入下一轮修改 |
| 撤销修改 | 回退到上一版本 |
| 调整修改 | 修正刚才的变更 |

### 响应模板

**确认完成时：**
```
演示文稿已完成所有修改。

修改总结：
- 内容修改: N 处
- 格式调整: N 处
- 新增幻灯片: N 页

文档已保存为: [文件名]
```

**继续修改时：**
```
好的，请告诉我还需要修改什么。

当前演示状态：
- 幻灯片数量: N 页
- 已完成 N 处修改
- 最后修改: [描述]
```

---

## 最佳实践

### 1. 精确定位

使用多种方式定位修改位置：
- 幻灯片编号（最可靠）
- 幻灯片标题
- 唯一文本片段
- 元素类型（标题/正文/图表）

**避免**：使用模糊描述（如"第一个图表"）

### 2. 最小化修改

```python
# 好的做法：只修改变化的文本节点
# 定位到具体的 <a:t> 元素进行修改

# 避免：替换整个幻灯片
# 这会丢失格式、动画等信息
```

### 3. 批量处理

相关修改分组处理：
- 同一幻灯片的多处修改 → 一次处理
- 同类型修改（如日期更新）→ 批量处理
- 每批 3-10 处修改

### 4. 验证修改

每次修改后验证：
```bash
# 重新打包
python ooxml/scripts/pack.py unpacked/ modified.pptx

# 验证文件完整性
python ooxml/scripts/validate.py modified.pptx

# 用 PowerPoint 或 LibreOffice 打开验证
```

---

## 常见场景

### 场景1：简单文本替换

```
用户: 把所有的"2024"改成"2025"

响应:
1. 搜索所有幻灯片中的"2024"
2. 批量替换
3. 生成摘要：共 N 处替换
```

### 场景2：格式调整

```
用户: 把所有标题改成蓝色

响应:
1. 定位所有标题元素（通常是 <p:ph type="title">）
2. 修改对应的 <a:solidFill> 颜色值
3. 生成摘要：N 个标题已调整颜色
```

### 场景3：添加幻灯片

```
用户: 在第3页后面加一页总结

响应:
1. 创建新的 slide*.xml
2. 更新 presentation.xml 中的幻灯片列表
3. 更新 [Content_Types].xml
4. 更新关系文件
5. 生成摘要：已在第3页后添加总结页
```

### 场景4：多轮迭代

```
第1轮: 用户提供演示文稿，要求修改标题
第2轮: 用户要求调整配色
第3轮: 用户要求添加新幻灯片
第4轮: 用户确认完成

每轮都：
- 执行修改
- 生成摘要
- 询问后续
```

---

## 错误处理

### 常见错误

| 错误 | 原因 | 解决方案 |
|------|------|---------|
| XML 解析失败 | 文档损坏 | 尝试修复或重新获取 |
| 找不到目标文本 | 文本被分割成多个 run | 使用 grep 查看实际结构 |
| 关系 ID 不匹配 | 添加/删除元素后未更新关系 | 检查 .rels 文件 |
| 幻灯片顺序错误 | presentation.xml 未正确更新 | 检查 sldIdLst 顺序 |

### 恢复策略

1. 保留原始文档备份
2. 每批修改后验证
3. 出错时回退到上一个正确状态

---

## 工具命令速查

```bash
# 解压演示文稿
python ooxml/scripts/unpack.py pres.pptx unpacked/

# 打包演示文稿
python ooxml/scripts/pack.py unpacked/ output.pptx

# 验证演示文稿
python ooxml/scripts/validate.py output.pptx

# 搜索文本
grep -rn "目标文本" unpacked/ppt/slides/

# 查看幻灯片列表
cat unpacked/ppt/presentation.xml | grep -o 'r:id="[^"]*"'
```

---

## PPTX 特有注意事项

### 幻灯片 ID 管理

每个幻灯片有两个 ID：
- `id`: 在 presentation.xml 中的唯一标识
- `r:id`: 关系文件中的引用 ID

添加/删除幻灯片时必须同时更新两者。

### 布局与母版

幻灯片继承自布局（slideLayout），布局继承自母版（slideMaster）。

修改样式时注意继承关系：
- 修改单个幻灯片：直接修改 slide*.xml
- 修改所有同类幻灯片：修改对应的 slideLayout
- 修改全局样式：修改 slideMaster

### 媒体资源

图片、视频等媒体存储在 `ppt/media/` 目录。

添加媒体时需要：
1. 将文件复制到 media 目录
2. 在 [Content_Types].xml 中声明类型
3. 在对应幻灯片的 .rels 文件中添加关系
4. 在 slide*.xml 中引用
