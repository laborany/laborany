# Diagram 多轮修改工作流指南

> 本文档详细说明如何在多轮对话中追踪图表状态、生成修改摘要、处理用户反馈。

---

## 核心理念

**增量修改优于全量重写**

每次修改只触及需要变更的部分，保留原图表的：
- 整体布局
- 样式主题
- 节点位置关系
- 已确认的内容

---

## 工作流程

### 第一轮：初始分析

```
1. 用户提供需求或素材
   ↓
2. 识别图表类型
   - 流程图 / 架构图 / 时序图 / 其他
   ↓
3. 使用 AskUserQuestion 向用户确认需求
   - 图表类型？
   - 图表用途？
   - 视觉风格？
   ↓
4. 【等待用户回答】
   ↓
5. 生成结构大纲
   ↓
6. 使用 AskUserQuestion 确认大纲
   ↓
7. 【等待用户回答】
   ↓
8. 生成 HTML 文件
   ↓
9. 告知用户文件位置
```

### 后续轮次：增量修改

```
1. 接收用户反馈
   ↓
2. 定位需要修改的部分
   - 使用节点编号
   - 使用节点内容
   - 使用元素类型
   ↓
3. 执行修改
   - 修改 HTML 文件中的 React 组件
   ↓
4. 生成修改摘要
   ↓
5. 使用 AskUserQuestion 询问后续需求
   ↓
6. 【等待用户回答】
```

---

## 图表状态追踪

### 状态信息

每轮对话需要追踪：

| 信息 | 说明 |
|------|------|
| 文件路径 | 当前操作的 HTML 文件位置 |
| 图表类型 | 流程图/架构图/时序图等 |
| 节点数量 | 当前图表的节点数 |
| 修改历史 | 本次会话的所有修改 |
| 待确认项 | 需要用户确认的问题 |

### 状态模板

```
## 当前图表状态

- 文件: [文件名]
- 类型: [图表类型]
- 节点数量: [N] 个
- 已完成修改: [N] 处
- 待处理: [描述]
```

---

## 修改摘要生成

### 格式规范

```markdown
## 修改摘要

本次修改共涉及 N 处变更：

### 内容修改
1. **[节点/位置]**:
   - 原文: "[原内容]"
   - 改为: "[新内容]"

### 样式调整
1. **[节点/位置]**: [调整说明]

### 新增内容
1. **[位置]**: 新增 [内容描述]

### 删除内容
1. **[位置]**: 删除 [内容描述]
```

### 示例

```markdown
## 修改摘要

本次修改共涉及 3 处变更：

### 内容修改
1. **节点2 - 处理步骤**:
   - 原文: "数据预处理"
   - 改为: "数据清洗与预处理"

2. **判断节点**:
   - 原文: "是否有效?"
   - 改为: "数据是否完整?"

### 样式调整
1. **所有节点**: 背景色从 bg-blue-500 调整为 bg-green-500
```

---

## 用户反馈处理

### 反馈类型与响应

| 反馈类型 | 响应方式 |
|---------|---------|
| 确认完成 | 告知用户可以导出 PNG |
| 继续修改 | 进入下一轮修改 |
| 撤销修改 | 回退到上一版本 |
| 调整修改 | 修正刚才的变更 |

### 响应模板

**确认完成时：**
```
图表已完成所有修改。

修改总结：
- 内容修改: N 处
- 样式调整: N 处
- 新增节点: N 个

请用浏览器打开 figures/{name}.html，点击"导出 PNG"按钮下载图片。
```

**继续修改时：**
```
好的，请告诉我还需要修改什么。

当前图表状态：
- 节点数量: N 个
- 已完成 N 处修改
- 最后修改: [描述]
```

---

## 最佳实践

### 1. 精确定位

使用多种方式定位修改位置：
- 节点编号（最可靠）
- 节点内容文本
- 节点类型（开始/结束/判断/处理）
- 相对位置（第一个/最后一个/某节点之后）

**避免**：使用模糊描述（如"那个蓝色的框"）

### 2. 最小化修改

```jsx
// 好的做法：只修改变化的属性
<RectNode text="新内容" color="blue" />

// 避免：重写整个组件结构
// 这会丢失其他已确认的配置
```

### 3. 批量处理

相关修改分组处理：
- 同类型节点的修改 → 一次处理
- 同一区域的修改 → 一次处理
- 每批 3-10 处修改

### 4. 验证修改

每次修改后验证：
```
1. 用浏览器打开 HTML 文件
2. 检查修改是否正确显示
3. 测试"导出 PNG"功能
```

---

## 常见场景

### 场景1：简单文本替换

```
用户: 把"用户输入"改成"数据输入"

响应:
1. 定位包含"用户输入"的节点
2. 修改 text 属性
3. 生成摘要：1 处文本替换
```

### 场景2：样式调整

```
用户: 把所有节点改成绿色

响应:
1. 定位所有 RectNode 组件
2. 修改 color 属性为 "green"
3. 生成摘要：N 个节点颜色已调整
```

### 场景3：添加节点

```
用户: 在"数据处理"后面加一个"数据验证"步骤

响应:
1. 定位"数据处理"节点位置
2. 在其后添加新的 RectNode
3. 添加连接箭头
4. 生成摘要：已添加"数据验证"节点
```

### 场景4：调整布局

```
用户: 把流程图改成水平方向

响应:
1. 修改容器的 flex 方向
2. 调整箭头组件（ArrowDown → ArrowRight）
3. 生成摘要：布局已调整为水平方向
```

### 场景5：多轮迭代

```
第1轮: 用户描述需求，AI 询问澄清问题
第2轮: 用户回答，AI 生成大纲
第3轮: 用户确认大纲，AI 生成图表
第4轮: 用户要求修改节点内容
第5轮: 用户要求调整颜色
第6轮: 用户确认完成

每轮都：
- 执行操作
- 生成摘要（如有修改）
- 询问后续
- 【等待用户回答】
```

---

## 错误处理

### 常见错误

| 错误 | 原因 | 解决方案 |
|------|------|---------|
| 浏览器显示空白 | JSX 语法错误 | 检查 React 组件语法 |
| 样式不生效 | Tailwind 类名错误 | 检查类名拼写 |
| 导出失败 | html2canvas 加载失败 | 检查网络连接 |
| 布局错乱 | flex 容器配置错误 | 检查 flex 方向和对齐 |

### 恢复策略

1. 保留原始文件备份
2. 每批修改后验证
3. 出错时回退到上一个正确状态

---

## 工具命令速查

```bash
# 用浏览器打开 HTML 文件（Windows）
start figures/diagram.html

# 用浏览器打开 HTML 文件（Mac）
open figures/diagram.html

# 用浏览器打开 HTML 文件（Linux）
xdg-open figures/diagram.html
```

---

## PNG 导出流程

### 导出方式

**零依赖手动导出**：用户通过外部浏览器完成导出，无需安装任何软件。

> ⚠️ **重要提示**：由于应用内 WebView 限制，PNG 导出功能无法在 laborany 应用内使用。
> 必须用 Chrome/Edge 等外部浏览器打开 HTML 文件才能导出。

### 导出步骤

```
1. AI 生成 HTML 文件 → figures/{name}.html
2. 告知用户文件位置和导出限制
3. 用户在文件管理器中找到文件，用 Chrome/Edge 浏览器打开
4. 点击页面上的"导出 PNG"按钮下载图片
5. 用户可继续修改，重复步骤 3-4
```

### 导出提示模板

生成图表后，使用以下模板告知用户：

```
图表已生成！

📁 文件位置: figures/{name}.html

📤 导出 PNG 方法:
⚠️ 由于应用内限制，请用 Chrome/Edge 浏览器打开上述 HTML 文件
1. 在文件管理器中找到该文件，双击用浏览器打开
2. 预览确认无误后，点击页面上的"导出 PNG"按钮
3. 图片将自动下载到您的下载文件夹

如需修改图表内容，请告诉我具体调整内容。
```

### 导出技术说明

模板内置 html2canvas 库实现一键导出：
- **分辨率**：2 倍缩放，确保清晰度
- **背景色**：白色背景，适合打印和文档
- **格式**：PNG 格式，支持透明度

---

## AskUserQuestion 使用规范

### 必须使用 AskUserQuestion 的场景

1. **阶段一：需求理解** - 询问图表类型、用途、风格
2. **阶段二：结构规划** - 确认大纲
3. **阶段五：迭代修改** - 询问后续需求

### AskUserQuestion 调用示例

```
使用 AskUserQuestion 工具，参数如下：

questions: [
  {
    question: "图表类型是什么？",
    header: "类型",
    options: [
      { label: "流程图", description: "算法步骤、业务流程、决策逻辑" },
      { label: "架构图", description: "系统设计、模块关系、技术栈" },
      { label: "时序图", description: "API 调用、消息传递、交互流程" }
    ],
    multiSelect: false
  }
]
```

### 关键规则

> **绝对禁止**：调用 AskUserQuestion 后自己假设答案继续执行。
> **必须**：等待用户回答后再继续下一步操作。

---

## Diagram 特有注意事项

### 节点 ID 管理

为每个节点分配唯一标识，便于后续修改定位：
- 使用有意义的 ID（如 `node-start`, `node-process-1`）
- 在注释中标注节点编号

### 连线管理

连线依赖节点位置，修改节点时注意：
- 添加节点后更新相关连线
- 删除节点后移除相关连线
- 移动节点后调整连线位置

### 主题一致性

修改样式时保持主题一致：
- 同类型节点使用相同颜色
- 连线颜色与节点协调
- 字体大小统一
