# DOCX 多轮修改工作流指南

> 本文档详细说明如何在多轮对话中追踪文档状态、生成修改摘要、处理用户反馈。

---

## 核心理念

**增量修改优于全量重写**

每次修改只触及需要变更的部分，保留原文档的：
- 格式和样式
- 元数据
- 修订历史
- 批注

---

## 工作流程

### 第一轮：初始分析

```
1. 用户提供文档
   ↓
2. 读取并分析文档结构
   - pandoc --track-changes=all doc.docx -o analysis.md
   ↓
3. 向用户确认需求
   - 任务类型？
   - 具体要求？
   - 格式偏好？
```

### 后续轮次：增量修改

```
1. 接收用户反馈
   ↓
2. 定位需要修改的部分
   - 使用 grep 在 document.xml 中定位
   - 记录修改位置
   ↓
3. 执行修改（使用修订模式）
   ↓
4. 生成修改摘要
   ↓
5. 询问后续需求
```

---

## 文档状态追踪

### 状态信息

每轮对话需要追踪：

| 信息 | 说明 |
|------|------|
| 文档路径 | 当前操作的文档位置 |
| 解压目录 | unpacked 目录路径 |
| 修改历史 | 本次会话的所有修改 |
| 待确认项 | 需要用户确认的问题 |

### 状态模板

```
## 当前文档状态

- 文档: [文件名]
- 解压目录: [路径]
- 已完成修改: [N] 处
- 待处理: [描述]
```

---

## 修改摘要生成

### 格式规范

```markdown
## 修改摘要

本次修改共涉及 N 处变更：

### 内容修改
1. **[位置/段落]**:
   - 原文: "[原内容]"
   - 改为: "[新内容]"

### 格式调整
1. **[位置]**: [调整说明]

### 新增内容
1. **[位置]**: 新增 [内容描述]

### 删除内容
1. **[位置]**: 删除 [内容描述]
```

### 示例

```markdown
## 修改摘要

本次修改共涉及 3 处变更：

### 内容修改
1. **第2段**:
   - 原文: "合同期限为30天"
   - 改为: "合同期限为60天"

2. **第5段**:
   - 原文: "甲方"
   - 改为: "委托方"

### 格式调整
1. **标题**: 字号从 14pt 调整为 16pt
```

---

## 用户反馈处理

### 反馈类型与响应

| 反馈类型 | 响应方式 |
|---------|---------|
| 确认完成 | 打包文档，提供下载 |
| 继续修改 | 进入下一轮修改 |
| 撤销修改 | 回退到上一版本 |
| 调整修改 | 修正刚才的变更 |

### 响应模板

**确认完成时：**
```
文档已完成所有修改。

修改总结：
- 内容修改: N 处
- 格式调整: N 处
- 新增内容: N 处

文档已保存为: [文件名]
```

**继续修改时：**
```
好的，请告诉我还需要修改什么。

当前文档状态：
- 已完成 N 处修改
- 最后修改: [描述]
```

---

## 最佳实践

### 1. 精确定位

使用多种方式定位修改位置：
- 段落编号
- 标题/章节
- 唯一文本片段
- 页码（如果适用）

**避免**：使用 markdown 行号（不对应 XML 结构）

### 2. 最小化修改

```python
# 好的做法：只修改变化的部分
'<w:r><w:t>合同期限为</w:t></w:r>'
'<w:del><w:r><w:delText>30</w:delText></w:r></w:del>'
'<w:ins><w:r><w:t>60</w:t></w:r></w:ins>'
'<w:r><w:t>天</w:t></w:r>'

# 避免：替换整个句子
'<w:del>..整句..</w:del><w:ins>..整句..</w:ins>'
```

### 3. 批量处理

相关修改分组处理：
- 同一段落的多处修改 → 一次处理
- 同类型修改（如日期更新）→ 批量处理
- 每批 3-10 处修改

### 4. 验证修改

每次修改后验证：
```bash
# 转换为 markdown 检查
pandoc --track-changes=all doc.docx -o verify.md

# 搜索确认修改
grep "新内容" verify.md
grep "原内容" verify.md  # 应该找不到
```

---

## 常见场景

### 场景1：简单文本替换

```
用户: 把所有的"甲方"改成"委托方"

响应:
1. 搜索所有"甲方"出现位置
2. 批量替换（使用修订模式）
3. 生成摘要：共 N 处替换
```

### 场景2：格式调整

```
用户: 把标题改成加粗

响应:
1. 定位所有标题元素
2. 添加 <w:b/> 标签
3. 生成摘要：N 个标题已加粗
```

### 场景3：结构调整

```
用户: 把第3段移到第5段后面

响应:
1. 提取第3段内容
2. 在第5段后插入
3. 删除原位置内容
4. 生成摘要：段落已移动
```

### 场景4：多轮迭代

```
第1轮: 用户提供文档，要求修改日期
第2轮: 用户要求调整格式
第3轮: 用户要求添加新段落
第4轮: 用户确认完成

每轮都：
- 执行修改
- 生成摘要
- 询问后续
```

---

## 错误处理

### 常见错误

| 错误 | 原因 | 解决方案 |
|------|------|---------|
| XML 解析失败 | 文档损坏 | 尝试修复或重新获取 |
| 找不到目标文本 | 文本被分割 | 使用 grep 查看实际结构 |
| 修订标记错误 | RSID 不匹配 | 使用 unpack 建议的 RSID |

### 恢复策略

1. 保留原始文档备份
2. 每批修改后验证
3. 出错时回退到上一个正确状态

---

## 工具命令速查

```bash
# 解压文档
python ooxml/scripts/unpack.py doc.docx unpacked/

# 打包文档
python ooxml/scripts/pack.py unpacked/ output.docx

# 转换为 markdown（带修订）
pandoc --track-changes=all doc.docx -o output.md

# 搜索文本
grep -n "目标文本" unpacked/word/document.xml
```
